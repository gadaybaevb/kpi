{% extends "analytics/base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h5 class="fw-bold mb-3"><i class="bi bi-filter-square me-2"></i>Анализ и Прогноз Cash Flow</h5>
            <form method="get" class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label class="small text-muted fw-bold">Филиал (ГО фильтруется автоматически)</label>
                    <select name="entity" class="form-select border-primary" onchange="this.form.submit()">
                        <option value="">-- Вся сеть (Консолидировано) --</option>
                        {% for ent in entities %}
                            <option value="{{ ent.id }}" {% if ent.id == selected_entity_id %}selected{% endif %}>
                                {{ ent.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-8">
                    <label class="small text-muted fw-bold d-block">Выберите периоды</label>
                    <div class="d-flex flex-wrap gap-4 mt-2">
                        {% for y in available_years %}
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="years" value="{{ y }}"
                                   id="year{{ y }}" {% if y in selected_years %}checked{% endif %} onchange="this.form.submit()">
                            <label class="form-check-label fw-bold" for="year{{ y }}">{{ y }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center p-3">
            <h5 class="mb-0 fw-bold">Движение денежных средств: Приход vs Расход</h5>
            <div class="d-flex gap-3">
                <span class="small"><span style="color: #198754">●</span> Факт (сплошная)</span>
                <span class="small"><span style="color: #198754">---</span> Прогноз (пунктир)</span>
            </div>
        </div>
        <div class="card-body">
            <div style="height: 450px;"><canvas id="mainCashFlowChart"></canvas></div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 fw-bold text-primary small text-uppercase">Банк (Поступления 1.02)</div>
                <div class="card-body"><div style="height: 280px;"><canvas id="bankInChart"></canvas></div></div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 fw-bold text-success small text-uppercase">Касса: Наличные (1.01.10)</div>
                <div class="card-body"><div style="height: 280px;"><canvas id="cashInChart"></canvas></div></div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-3 fw-bold text-warning small text-uppercase">Касса: Безнал (1.01.11)</div>
                <div class="card-body"><div style="height: 280px;"><canvas id="nonCashInChart"></canvas></div></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const months = {{ months_labels|safe }};
    const rawData = {{ comparison_data_json|safe }};

    const yearColors = {
        2024: { in: '#2a9d8f', out: '#e76f51' },
        2025: { in: '#198754', out: '#dc3545' },
        2026: { in: '#0d6efd', out: '#6610f2' }
    };

    function createDatasets(year, key, labelSuffix, colorBase) {
        const dataObj = rawData[year][key];
        if (!dataObj) return [];

        return [
            {
                label: `${year} ${labelSuffix} (Факт)`,
                data: dataObj.fact.map(v => v > 0 ? v : null),
                borderColor: colorBase,
                backgroundColor: colorBase,
                borderWidth: 4,
                tension: 0.3,
                pointRadius: 4,
                spanGaps: false
            },
            {
                label: `${year} ${labelSuffix} (Прогноз)`,
                data: dataObj.forecast,
                borderColor: colorBase,
                borderDash: [6, 4],
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                fill: false
            }
        ];
    }

    function initCharts() {
        // 1. Главный график
        const mainCtx = document.getElementById('mainCashFlowChart').getContext('2d');
        let mainDatasets = [];

        Object.keys(rawData).sort().forEach(year => {
            const color = yearColors[year] || { in: '#333', out: '#999' };
            mainDatasets = mainDatasets.concat(createDatasets(year, 'TOTAL_IN', 'Приход', color.in));
            mainDatasets = mainDatasets.concat(createDatasets(year, 'TOTAL_OUT', 'Расход', color.out));
        });

        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: 15,
                        filter: (item) => !item.text.includes('(Прогноз)')
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(ctx) {
                            let label = ctx.dataset.label || '';
                            const val = ctx.parsed.y;
                            if (label.includes('(Прогноз)')) {
                                const year = label.split(' ')[0];
                                const type = label.includes('Приход') ? 'Приход' : 'Расход';
                                const factExists = ctx.chart.data.datasets.some(ds =>
                                    ds.label === `${year} ${type} (Факт)` && ds.data[ctx.dataIndex] !== null
                                );
                                if (factExists) return null;
                            }
                            return `${label}: ${val.toLocaleString()} сум`;
                        }
                    }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                x: { grid: { display: false } }
            }
        };

        new Chart(mainCtx, { type: 'line', data: { labels: months, datasets: mainDatasets }, options: commonOptions });

        // 2. Малые графики
        renderSub('bankInChart', 'BANK_IN', 'Приход (Банк)', '#0d6efd');
        renderSub('cashInChart', 'CASH_10_IN', 'Наличные', '#198754');
        renderSub('nonCashInChart', 'CASH_11_IN', 'Безнал', '#ffc107');
    }

    function renderSub(id, key, label, defaultColor) {
        let ds = [];
        Object.keys(rawData).sort().forEach(year => {
            const yearColor = yearColors[year] ? yearColors[year].in : defaultColor;
            ds = ds.concat(createDatasets(year, key, label, yearColor));
        });

        new Chart(document.getElementById(id), {
            type: 'line',
            data: { labels: months, datasets: ds },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', initCharts);
</script>

<style>
    .card { border-radius: 12px; }
    .card-header { border-bottom: 1px solid #f0f0f0 !important; }
    .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
</style>
{% endblock %}
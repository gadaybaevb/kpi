{% extends "analytics/base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h5 class="fw-bold mb-3"><i class="bi bi-filter-square me-2"></i>Аналитический прогноз ОПУ</h5>
            <form method="get" id="filterForm" class="row g-3 align-items-center">
                <div class="col-md-4">
                    <label class="small text-muted fw-bold">Филиал</label>
                    <select name="entity" class="form-select border-primary" onchange="this.form.submit()">
                        <option value="">-- Вся сеть (Консолидировано) --</option>
                        {% for ent in entities %}
                            <option value="{{ ent.id }}" {% if ent.id == selected_entity_id %}selected{% endif %}>{{ ent.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-8">
    <label class="small text-muted fw-bold d-block">Периоды сравнения и данные</label>
    <div class="d-flex gap-4 mt-2 align-items-center">
        {% for y in available_years %}
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="years" value="{{ y }}"
                   id="year{{ y }}" {% if y in selected_years %}checked{% endif %} onchange="this.form.submit()">
            <label class="form-check-label fw-bold" for="year{{ y }}">{{ y }}</label>
        </div>
        {% endfor %}

        <div class="vr mx-2"></div> <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="togglePlan" checked onchange="togglePlanLines()">
            <label class="form-check-label fw-bold text-orange" for="togglePlan" style="color: #fd7e14;">Показать План</label>
        </div>
    </div>
</div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 d-flex justify-content-between">
                    <h5 class="mb-0 fw-bold text-success">Продажи (Выручка)</h5>
                    <span class="small text-muted">Пунктир = Сезонный прогноз</span>
                </div>
                <div class="card-body"><div style="height: 350px;"><canvas id="salesChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 fw-bold text-info">Количество слушателей</div>
                <div class="card-body"><div style="height: 300px;"><canvas id="studentsChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3 fw-bold text-primary">Чистая прибыль</div>
                <div class="card-body"><div style="height: 300px;"><canvas id="profitChart"></canvas></div></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const months = {{ months_labels|safe }};
    const rawData = {{ comparison_data_json|safe }};
    const charts = {}; // Объект для хранения экземпляров графиков

    const yearPalette = {
        2024: '#2a9d8f',
        2025: '#198754',
        2026: '#0d6efd',
        2027: '#6f42c1'
    };

    function createDatasets(categoryName) {
        const datasets = [];
        Object.keys(rawData).sort().forEach(year => {
            const color = yearPalette[year] || '#333';
            const yearData = rawData[year][categoryName];

            // 1. Линия Факта
            datasets.push({
                label: `${year} (Факт)`,
                data: yearData.fact.map(v => v !== 0 ? v : null),
                borderColor: color,
                backgroundColor: 'transparent',
                borderWidth: 4,
                tension: 0.3,
                pointRadius: 4,
                spanGaps: false
            });

            // 2. Линия Плана
            if (yearData.plan && yearData.plan.some(v => v !== 0)) {
                datasets.push({
                    label: `${year} (План)`,
                    data: yearData.plan,
                    borderColor: '#fd7e14',
                    borderDash: [5, 5],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 0,
                    fill: false,
                    hidden: false, // Начальное состояние
                    isPlan: true   // Кастомный флаг для поиска
                });
            }

            // 3. Линия Прогноза
            datasets.push({
                label: `${year} (Прогноз)`,
                data: yearData.forecast,
                borderColor: color,
                borderDash: [2, 2],
                backgroundColor: 'transparent',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 0,
                fill: false
            });
        });
        return datasets;
    }

    // Функция переключения видимости плана
    function togglePlanLines() {
        const showPlan = document.getElementById('togglePlan').checked;

        Object.values(charts).forEach(chart => {
            chart.data.datasets.forEach(dataset => {
                if (dataset.isPlan) {
                    dataset.hidden = !showPlan;
                }
            });
            chart.update();
        });
    }

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    filter: (item) => !item.text.includes('(Прогноз)') && !item.text.includes('(План)')
                }
            },
            tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                    label: function(ctx) {
                        const label = ctx.dataset.label;
                        if (label.includes('(Прогноз)')) {
                            const year = label.split(' ')[0];
                            const factDS = ctx.chart.data.datasets.find(d => d.label === `${year} (Факт)`);
                            if (factDS && factDS.data[ctx.dataIndex] !== null) return null;
                        }
                        return label + ': ' + ctx.parsed.y.toLocaleString('ru-RU');
                    }
                }
            }
        },
        scales: { y: { beginAtZero: false } }
    };

    // Создаем графики и сохраняем их в объект charts
    charts.sales = new Chart(document.getElementById('salesChart'), {
        type: 'line',
        data: { labels: months, datasets: createDatasets('ИТОГО ПРОДАЖИ') },
        options: commonOptions
    });

    charts.students = new Chart(document.getElementById('studentsChart'), {
        type: 'line',
        data: { labels: months, datasets: createDatasets('КОЛИЧЕСТВО СЛУШАТЕЛЕЙ') },
        options: commonOptions
    });

    charts.profit = new Chart(document.getElementById('profitChart'), {
        type: 'line',
        data: { labels: months, datasets: createDatasets('ЧИСТАЯ ПРИБЫЛЬ') },
        options: commonOptions
    });

    // Вызываем один раз при загрузке, чтобы синхронизировать состояние чекбокса
    togglePlanLines();
</script>
{% endblock %}
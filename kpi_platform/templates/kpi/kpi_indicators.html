{% extends "base.html" %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'admin_manage' %}" class="text-brand text-decoration-none">Все KPI</a></li>
    <li class="breadcrumb-item active">{{ current_kpi.name }} (v{{ current_kpi.version }})</li>
  </ol>
</nav>

<div class="card shadow-sm border-0 mb-4 bg-light border-start border-4 border-success">
    <div class="card-body d-flex justify-content-between align-items-center py-3">
        <div>
            <span class="text-muted small text-uppercase fw-bold">Целевой бонус:</span>
            <span class="h5 mb-0 ms-2 fw-bold text-dark">{{ current_kpi.bonus_setup.target_amount|default:"0" }} ₽</span>
        </div>
        <div>
            <span class="text-muted small text-uppercase fw-bold">Пороги (Мин/Макс):</span>
            <span class="badge bg-dark ms-2">{{ current_kpi.bonus_setup.threshold_min|default:"80" }}% — {{ current_kpi.bonus_setup.threshold_max|default:"120" }}%</span>
        </div>
        <div>
            {% if current_kpi.bonus_setup.is_calculated %}
                <span class="badge bg-success p-2">РАССЧИТАНО: {{ current_kpi.bonus_setup.final_payout }} ₽</span>
            {% else %}
                <span class="badge bg-warning text-dark p-2">ОЖИДАЕТ ПОДТВЕРЖДЕНИЯ</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-brand-red text-white d-flex justify-content-between align-items-center py-3">
        <h4 class="mb-0">Индикаторы: {{ current_kpi.name }}</h4>
        <a href="{% url 'indicator_add' current_kpi.pk %}" class="btn btn-light btn-sm fw-bold">+ Добавить индикатор</a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Наименование</th>
                        <th class="text-center">Вес</th>
                        <th class="text-center">План / Пороги</th>
                        <th class="text-center">Текущий факт (%)</th>
                        <th class="text-center">Вклад в KPI</th>
                        <th class="text-end pe-4">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ind in indicators %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold">{{ ind.name }}</div>
                            <div class="small text-muted">Статус:
                                <span class="badge {% if ind.status == 'approved' %}bg-success{% elif ind.status == 'on_review' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ ind.get_status_display }}
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-dark">{{ ind.weight }}%</span>
                        </td>
                        <td class="text-center">
                            <div class="fw-bold">{{ ind.plan_value }}</div>
                            <div class="text-muted small">{{ ind.threshold_min }}% - {{ ind.threshold_max }}%</div>
                        </td>
                        <td class="text-center bg-light">
                            <div class="fw-bold text-brand">Итог: {{ ind.total_performance|floatformat:1 }}%</div>
                        </td>
                        <td class="text-center fw-bold">{{ ind.weighted_result|floatformat:1 }}%</td>
                        <td class="text-end pe-4">
                            <div class="btn-group">
                                <a href="{% url 'indicator_update_fact' ind.pk %}" class="btn btn-sm btn-outline-brand">Внести факт</a>
                                <a href="{% url 'indicator_edit' ind.pk %}" class="btn btn-sm btn-outline-secondary">✎</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-light border-top-2">
                    <tr class="fw-bold">
                        <td colspan="4" class="text-end ps-4 py-3">ОБЩИЙ ПРОЦЕНТ ВЫПОЛНЕНИЯ:</td>
                        <td class="text-center text-brand fs-5 py-3">{{ current_kpi.get_total_score|floatformat:2 }}%</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
{% endblock %}